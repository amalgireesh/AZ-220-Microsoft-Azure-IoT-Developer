## Lab Scenario

Analyze the data collected from the devices to uncover hidden trends, spotting anomalies, and conduct root-cause analysis.

You will need to store all data in long-term storage for the cold path analysis and filter a subset of the telemetry data for real-time analysis and visualization on the hot path.

> **IMPORTANT**: This lab has several service prerequisites that are not related to the Azure subscription you were given for the course:
>
> 1. The ability to sign in to a "Work or School Account" (Azure Active Directory account)
> 2. You must know your account sign-in name, which may not match your e-mail address.
> 3. Access to Power BI, which could be through:
>       1. An existing Power BI account
>       2. The ability to sign up for Power BI - some organizations block this.
>
> The first lab exercise will validate your ability to access Power BI.  If you are not successful in the first exercise, you will not be able to complete the lab, as there is no quick workaround for blocked access to a work or school account.

### Make a Call to a Built-in Machine Learning Model

In this lab, you will be calling a built-in Machine Learning (ML) function named `AnomalyDetection_SpikeAndDip`. The `AnomalyDetection_SpikeAndDip` function uses a sliding window to analyze data for anomalies. The sliding window could be, for example, the most recent two minutes of telemetry data. The window advances in near real-time with the flow of telemetry. Generally speaking, if the size of the sliding window is increased to include more data, the accuracy of anomaly detection will increase as well (however, the latency also increases, so a balance must be found).

The function establishes a "normal" range for the data and then uses it to identify anomalies and assign a rating. It works like this: as the function continues to monitor the flow of data, the algorithm establishes a normal range of values, then compares new values against those norms. The result is a score for each value, expressed as a percentage that determines the confidence level that the given value is anomalous. As you may expect, low confidence levels can be ignored, but you may wonder what percentage confidence value is acceptable. In your query, you will set this tipping point at 95%.

There are always complications, like when there are gaps in the data (the conveyor belt stops for a while, perhaps). The algorithm handles voids in the data by imputing values.

> **Note**: In statistics, imputation is the process of replacing missing data with substituted values. You can learn more about imputations [here](https://en.wikipedia.org/wiki/Imputation_%28statistics%29).

Spikes and dips in telemetry data are temporary anomalies. However, since you are simulating vibration data using sine waves, you can expect a period of "normal" values followed by a high or low value that triggers an anomaly alert. An operator may look for a cluster of anomalies occurring in a short time span, which would signal that something is wrong.

There are other built-in ML models, such as a model for detecting trends. We don't include these models as part of this module, but the student is encouraged to investigate further.

### Visualize data using Power BI

Visualizing numerical data, especially volumes of it, is a challenge in itself. How can we alert a human operator of the sequence of anomalies that infer something is wrong?

The solution we use in this module is to use some built-in functionality of Power BI along with the ability of Azure Stream Analytics to send data in a real-time format that Power BI can ingest.

We use the dashboard feature of Power BI to create a number of tiles. One tile contains the actual vibration measurement. Another tile is a gauge, showing from 0.0 to 1.0 the confidence level that the value is an anomaly. A third tile indicates if the 95% confidence level is reached. Finally, the fourth tile shows the number of anomalies detected over the past hour. By including time as the x-axis, this tile makes it clear if a clutch of anomalies were detected in short succession as they will be clustered together horizontally.

The fourth tile allows you to compare the anomalies with the red text in the telemetry console window. Is there a cluster of anomalies being detected when forced, or increasing, or both, vibrations are in action?

The following resources will be created:

![Lab 8 Architecture](media/LAB_AK_08-architecture.png)

## In This Lab

In this lab, you will complete the following activities:

* Sign-up for Power BI
* Check data in blob storage using Storage Explorer
* Visualize hot path data in PowerBI
* View Time Series Insights Explorer


### Exercise 1: Hot path data processing with Stream Analytics

Power BI can be your personal data analysis and visualization tool, and can also serve as the analytics and decision engine behind group projects, divisions, or entire corporations. Later on in this lab, you will build a dashboard and visualize data using Power BI. This exercise explains how to sign up for Power BI as an individual.

#### Task 1: Starting Stream Analytics Job

1. On the resource group tile, click iot-{deployment-id} and select the stream analytics job named **iotstreamjob-{deployment-id}**.

1. From the **Overview** blade of your **Stream Analytics job** and select **Start**.

1. In the **Start job** blade, select **Now** (the job will start processing messages from the current point in time onward).

1. Select **Start**.

1. Allow your Stream Analytics Job a few minutes to start.

1. Once the Stream Analytics Job has successfully started, verify that you are showing a non-zero amount of **Input Events** on the **Monitoring** chart on the **Overview** blade. You may need to reconnect your devices on the **IoT Simulator** and let it run for a while to see the events.

### Task 2: Visualize hot data with Power BI

1. Sign in to your Power BI subscription (<https://app.powerbi.com>) to see if data is being collected.

2. Select **My Workspace** on the left-hand menu, then select the **Datasets tab**, and locate the **temp** dataset from the list.

   > **Note:** Sometimes it takes few minutes for the dataset to appear in the Power BI Dataset tab under **My Workspace**

3. Select the **Create Report** button under the **Actions** column.

4. On the **Visualizations** palette, select **Stacked column chart** to create a chart visualization.

5. In the **Fields** listing, drag the **id** field, and drop it into the **Axis** field.

6. Next, drag the **average** field and drop it into the **Values** field.

7. Now, set the **Value** to **Max of average**, by selecting the down arrow next to **average**, and select **Maximum**.

8. Repeat steps 5-8, this time adding a Stacked Column Chart for **Min of average**. (You may need to select on any area of white space on the report designer surface to deselect the Max of average by id chart visualization.)  

9. Next, add a **table visualization**.

10. Set the values to **id** and **Average of average**, by dragging and dropping both fields in the **Values** field, then selecting the dropdown next to **average**, and selecting **Average**.

11. Go to File, from the dropdown Select **Save** to save the report.

12. Enter the name `Average Temperatures`, and select **Save**.

13. Within the report, select one of the columns to see the data for just that device.

### Exercise 2: Check data in blob storage using Storage Explorer

### Task 1: Check data in blob storage (Storage Explorer)

1. On the resource group tile, click iot-{deployment-id} and select the storage account named **iotstorage{deployment-id}**.

1. On the left-side menu, click **Storage Explorer (preview)**.

    You can use Storage Explorer for additional reassurance that all of your data is getting to the storage account. 

    > **Note**:  The Storage Explorer is currently in preview mode, so its exact mode of operation may change.

1. In **Storage Explorer (preview)**, under **BLOB CONTAINERS**, click **tempcontainer**.

    To view the data, you will need to navigate down a hierarchy of folders. The first folder will be named for the IoT Hub, the next will be a partition, then year, month, day and finally hour. 

1. In the right-hand pane, under **Name**, double-click the folder **output**, and then use double-clicks to navigate down into the hierarchy until you open the most recent hour folder.

    Within the hour folder, you will see files named for the minute they were generated. This verifies that your data is reaching the storage location as intended.

> **IMPORTANT**: Do not remove these resources until you have completed the Data Visualization module of this course.


### Exercise 3: View Time Series Insights Explorer

1. 1. On the resource group tile, click iot-{deployment-id} and select the time series environment named **iot-{deployment-id}**.

1. On the **Time Series Insights environment** blade, at the top of the **Overview** pane, click **Go to Environment**.

    This will open the **Time Series Insights Explorer** in a new browser tab.

1. On the toolbar at the top of the page, if there is an option to enable the **Preview**, set **Preview** to **On**

1. Select Checkout a demo environment.Your environment will be loaded with 2 sample datasets Contoso Plant 1 and Contoso Plant 2.

1. Remove the existing queries by clicking on the **delete** icon.

     >**Note** : To see the delete icon, move the cursor to left side of the selected query.
      
      
1. On the left pane, expand Contoso Plant 1, then W6 and later on Weather System.

1. Expand Weather System then OutdoorTemperature.

1. Click on the listed data, then select **Reading** and Click on **Add**.

1. You can adjust the interval by clicking down the Interval selector above the graph area.

1. From the **Interval** dropdown, you can select time so that data 

