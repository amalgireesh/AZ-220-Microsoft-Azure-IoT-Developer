# Explore and analyze time stamped data with Time Series Insights

## Lab Scenario

Your hard work implementing Azure IoT services and tools has paid off. Contoso has rolled out their "Asset Condition Tracking System" that monitors the environmental conditions of cheese containers during shipment.

Two weeks after launching the new system it has revealed a temperature spike in-transit for a specific shipment. Some of the cheese in the shipment was ruined, but the new system did ensure that the affected cheese wasn't delivered to the customer. Since you know the Azure IoT side of the monitoring system better than anyone, you will lead the investigation.

Management has asked you to determine if the system can be improved, hopefully to the point where it will prevent the loss of product in the future. You correlate the IoT devices' sensor data taken from the trucks and planes used during the shipment. It appears that the temperature in one of the trucks rose unexpectedly in a particular area of the vehicle and created the heat spike in one of the transport containers (which was equipped with an IoT device monitoring temperature and humidity).

Your team decides that further improvements to the monitoring system will require near real-time data exploration and root-cause analysis.

You propose adding Time Series Insights to the Azure IoT solution. This will enable Contoso to quickly store, visualize, and query the large amounts of time series data that are generated by the IoT devices in the trucks, planes, and containers, and to visualize changes over time. 

The following resources will be created:

![Lab 10 Architecture](media/LAB_AK_10-architecture.png)

## In This Lab

In this lab, you will complete the following activities:
* Connect to IoT Hub with Time Series Insights (TSI)
* View time series data using the Time Series Insights (TSI) Explorer

### Exercise 1: Run Simulated IoT Devices

In this exercise, you will run the simulated devices so they starts sending telemetry events to Azure IoT Hub.

1. Open **Visual Studio Code**.

1. On the **File** menu, click **Open Folder**.

1. In the **Open Folder** dialog, navigate to the lab 10 Starter folder.

    In _Lab 3: Setup the Development Environment_, you cloned the GitHub repository containing lab resources by downloading a ZIP file and extracting the contents locally. The extracted folder structure includes the following folder path:

    * Allfiles
      * Labs
          * 10-Explore and analyze time stamped data with Time Series Insights
            * Starter

1. In the **Open Folder** dialog, click **ContainerSimulation**, and then click **Select Folder**.

    If prompted, load the C# extension and/or perform a restore.
 
1. In the EXPLORER pane, to open the Program.cs file, click **Program.cs**.

1. Locate the variables used to assign the connections strings

    ```csharp
    private readonly static string connectionStringTruck = "{Your Truck device connection string here}";
    private readonly static string connectionStringAirplane = "{Your Airplane device connection string here}";
    private readonly static string connectionStringContainer = "{Your Container device connection string here}";
    ```

1. Update the variable assignments with the connection strings that you saved earlier in the lab. 

    Be sure to replace the placeholder values with the Connection String for the corresponding IoT device.

1. On the **File** menu, click **Save**.

1. On the **View** menu, click **Terminal**.

1. Within the **Terminal** pane, ensure that the command prompt specifies the path to the lab 10 `/Starter/ContainerSimulation` directory.

1. At the command prompt, to build and run the **ContainerSimulation** app, enter the following command:

    ```cmd/sh
    dotnet run
    ```

1. Notice the messages displayed in the Terminal pane.

    Once the **ContainerSimulation** app is running, it will begin outputting telemetry data to the terminal. This is the telemetry data that it is sending to Azure IoT Hub.

    When the **ContainerSimulation** app is running, the **Terminal** output will look similar to the following:

    ```text
    12/27/2019 8:51:30 PM > Sending TRUCK message: {"temperature":35.15660452608195,"humidity":48.422323938240865}
    12/27/2019 8:51:31 PM > Sending AIRPLANE message: {"temperature":17.126545186374237,"humidity":36.46941012936869}
    12/27/2019 8:51:31 PM > Sending CONTAINER message: {"temperature":21.986403302500637,"humidity":47.847680384455096}
    12/27/2019 8:51:32 PM > Sending TRUCK message: {"temperature":36.10474464823629,"humidity":48.82029906486022}
    12/27/2019 8:51:32 PM > Sending AIRPLANE message: {"temperature":16.55005930170971,"humidity":36.49988437459935}
    12/27/2019 8:51:32 PM > Sending CONTAINER message: {"temperature":21.811727088543286,"humidity":50.0}
    ```

1. Leave the **ContainerSimulation** app running for the remainder of this lab.

    This will ensure device telemetry from the three devices (Container, Truck, and Airplane) is being sent to Azure IoT Hub.

1. After the **ContainerSimulation** app has been running for 30 seconds, you will see a message telling you that the **Container** device is changing transport methods.

    The transport method will change between **Truck** and **Airplane** every 30 seconds. The **Terminal** output will look like the following when this happens:

    ```text
    12/27/2019 8:51:40 PM > CONTAINER transport changed to: TRUCK
    ```

    > **Note**:  In production the shipping container would only change transport methods during the normal course of shipping. For the simulated scenario in this lab, it's performed every 30 seconds to give a short enough data duration that will fit during the course of performing the steps in this lab.

### Exercise 2: View Time Series Insights Explorer

In this exercise, you will be introduced to working with time series data using the Time Series Insights (TSI) Explorer.

1. If needed, log in to [portal.azure.com](https://portal.azure.com) using your Azure account credentials.

    If you have more than one Azure account, be sure that you are logged in with the account that is tied to the subscription that you will be using for this course.

1. On your Resource group tile, click **tsi-az220-training**.

1. On the **Time Series Insights environment** blade, at the top of the **Overview** pane, click **Go to Environment**.

    This will open the **Time Series Insights Explorer** in a new browser tab.

1. On the toolbar at the top of the page, if there is an option to enable the **Preview**, set **Preview** to **On**.

1. On the left-side menu, ensure that **Analyze** is selected.

    You can expand the navigation menu to display the button names. The two options are "Analyze" and "Model". Choose Analyze.

    Collapse the navigation menu to ensure that you can see the query edit area on the left side of the page.

1. In the query editor, open the **MEASURE** dropdown, and then click **temperature**.

1. Open the **SPLIT BY** dropdown, and then click **iothub-connection-device-id**.

    When you run the query, this will split the graph to show the telemetry from each of the IoT Devices separately on the graph.

1. Click **Add**.

1. At the top of the page, to have the display automatically refresh, click **Auto Refresh**.

    When **Auto refresh** is enabled, the display will be updated every _30 seconds_ to display the latest data. This only applies to the last 1 hour of available data.

1. Notice the graph now displays the **temperature** sensor event data from the IoT Devices within Azure IoT Hub in a _Line Chart_.

1. Notice the list of **Device IDs** to the left of the graph. 

    Hovering the mouse over a specific Device ID will highlight it's data on the graph display.

1. Take a moment to examine the temperature data (graphs) for the telemetry streaming into the system from the three simulated devices.

1. Notice that the spikes in **temperature** of the **sensor-th-container0001** correlate with the temperature spikes of either the **sensor-th-truck0001** or the **sensor-th-airplane0001**.

    This gives you an indication that the sensor-th-container0001 is being transported by Truck or Airplane at those times.

1. To add a second query to the display, set the **MEASURE** dropdown to **humidity**, set the **SPLIT BY** dropdown to **iothub-connection-device-id**, and then click **Add**.

    Notice that there are now two graphs displayed. The top graph shows **temperature** while the lower graph shows **humidity**, both using their own Y-axis scale.

1. Position your mouse pointer over one of the graph lines.

    Notice that when you hover the mouse cursor over the graph, a popup will display the details for a point on the graph. The popup displays the minimum (**min**), average (**avg**), and maximum (**max**) values for the data points in the graph (over the short time represented by that point). The time range associated with the selected data point is displayed along the time axis at the bottom of the display.

1. Above the vertical axis line, notice the options that you can use to control graph settings.

1. Change the Interval setting to 15 seconds.

    Notice how the appearance of the data changes as you increase the interval.

Once you have completed exploring the data, don't forget to stop the container simulator app by pressing **CTRL+C** in the terminal.
